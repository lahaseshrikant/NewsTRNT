// NewsTRNT Platform Database Schema
// Production-ready schema for comprehensive news platform
// Supports admin portal, AI features, analytics, and scalability

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String   @id @default(uuid())
  email                 String   @unique
  username              String?  @unique
  passwordHash          String?  @map("password_hash")
  fullName              String?  @map("full_name")
  avatarUrl             String?  @map("avatar_url")
  bio                   String?
  isVerified            Boolean  @default(false) @map("is_verified")
  isAdmin               Boolean  @default(false) @map("is_admin")
  emailVerified         Boolean  @default(false) @map("email_verified")
  preferences           Json     @default("{}")
  readingHistory        Json     @default("[]") @map("reading_history")
  interests             String[] @default([])
  language              String   @default("en")
  timezone              String   @default("UTC")
  notificationSettings  Json     @default("{\"email\": true, \"push\": true, \"breaking\": true}") @map("notification_settings")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  lastLoginAt           DateTime? @map("last_login_at")

  // Relations
  articles              Article[] @relation("ArticleAuthor")
  updatedArticles       Article[] @relation("ArticleUpdater")
  webStories            WebStory[] @relation("WebStoryAuthor")
  updatedWebStories     WebStory[] @relation("WebStoryUpdater")
  comments              Comment[]
  savedArticles         SavedArticle[]
  readingHistoryRecords ReadingHistory[]
  interactions          UserInteraction[]
  newsletters           NewsletterSubscription[]
  pushTokens            PushToken[]
  adminLogs             AdminLog[]
  analyticsEvents       AnalyticsEvent[]

  @@map("users")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  color       String   @default("#000000")
  icon        String?
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  isDeleted   Boolean  @default(false) @map("is_deleted")
  deletedAt   DateTime? @map("deleted_at")
  deletedBy   String?  @map("deleted_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  articles   Article[]
  webStories WebStory[]

  @@index([isDeleted])
  @@index([deletedAt])
  @@map("categories")
}

model Tag {
  id         String   @id @default(uuid())
  name       String   @unique
  slug       String   @unique
  usageCount Int      @default(0) @map("usage_count")
  isDeleted  Boolean  @default(false) @map("is_deleted")
  deletedAt  DateTime? @map("deleted_at")
  deletedBy  String?  @map("deleted_by")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  articles ArticleTag[]

  @@index([isDeleted])
  @@index([deletedAt])
  @@map("tags")
}

model Article {
  id               String    @id @default(uuid())
  title            String
  slug             String    @unique
  summary          String?
  content          String?
  shortContent     String?   @map("short_content")
  excerpt          String?
  author           String?
  sourceName       String?   @map("source_name")
  sourceUrl        String?   @map("source_url")
  imageUrl         String?   @map("image_url")
  images           Json      @default("[]")
  videoUrl         String?   @map("video_url")
  audioUrl         String?   @map("audio_url")
  categoryId       String?   @map("category_id")
  publishedAt      DateTime? @map("published_at")
  scrapedAt        DateTime  @default(now()) @map("scraped_at")
  isPublished      Boolean   @default(false) @map("is_published")
  isFeatured       Boolean   @default(false) @map("is_featured")
  isTrending       Boolean   @default(false) @map("is_trending")
  isBreaking       Boolean   @default(false) @map("is_breaking")
  isFactChecked    Boolean   @default(false) @map("is_fact_checked")
  factCheckStatus  String    @default("pending") @map("fact_check_status")
  factCheckNotes   String?   @map("fact_check_notes")
  readingTime      Int?      @map("reading_time")
  engagementScore  Float     @default(0) @map("engagement_score")
  viewCount        Int       @default(0) @map("view_count")
  likeCount        Int       @default(0) @map("like_count")
  shareCount       Int       @default(0) @map("share_count")
  commentCount     Int       @default(0) @map("comment_count")
  aiGenerated      Boolean   @default(false) @map("ai_generated")
  aiSummary        Boolean   @default(false) @map("ai_summary")
  aiMetadata       Json      @default("{}") @map("ai_metadata")
  seoTitle         String?   @map("seo_title")
  seoDescription   String?   @map("seo_description")
  seoKeywords      String[]  @map("seo_keywords")
  metaData         Json      @default("{}") @map("meta_data")
  isDeleted        Boolean   @default(false) @map("is_deleted")
  deletedAt        DateTime? @map("deleted_at")
  deletedBy        String?   @map("deleted_by")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  createdBy        String?   @map("created_by")
  updatedBy        String?   @map("updated_by")

  // Relations
  category         Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  createdByUser    User?     @relation("ArticleAuthor", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser    User?     @relation("ArticleUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  tags             ArticleTag[]
  comments         Comment[]
  savedByUsers     SavedArticle[]
  readingHistory   ReadingHistory[]
  interactions     UserInteraction[]

  @@index([publishedAt(sort: Desc)])
  @@index([categoryId])
  @@index([isPublished])
  @@index([isTrending])
  @@index([isFeatured])
  @@index([slug])
  @@index([isDeleted])
  @@index([deletedAt])
  @@map("articles")
}

model ArticleTag {
  articleId String @map("article_id")
  tagId     String @map("tag_id")

  // Relations
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
  @@map("article_tags")
}

model Comment {
  id         String    @id @default(uuid())
  articleId  String    @map("article_id")
  userId     String    @map("user_id")
  parentId   String?   @map("parent_id")
  content    String
  isApproved Boolean   @default(true) @map("is_approved")
  isFlagged  Boolean   @default(false) @map("is_flagged")
  likeCount  Int       @default(0) @map("like_count")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  article Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([articleId])
  @@map("comments")
}

model SavedArticle {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  articleId String   @map("article_id")
  savedAt   DateTime @default(now()) @map("saved_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@index([userId])
  @@map("saved_articles")
}

model ReadingHistory {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  articleId        String   @map("article_id")
  readAt           DateTime @default(now()) @map("read_at")
  readingTime      Int?     @map("reading_time")
  scrollPercentage Float    @default(0) @map("scroll_percentage")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@index([userId])
  @@map("reading_history")
}

model UserInteraction {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  articleId       String   @map("article_id")
  interactionType String   @map("interaction_type")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId, interactionType])
  @@map("user_interactions")
}

model NewsletterSubscription {
  id             String    @id @default(uuid())
  email          String
  userId         String?   @map("user_id")
  frequency      String    @default("daily")
  categories     String[]  @default([])
  isActive       Boolean   @default(true) @map("is_active")
  subscribedAt   DateTime  @default(now()) @map("subscribed_at")
  unsubscribedAt DateTime? @map("unsubscribed_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([email, frequency])
  @@map("newsletter_subscriptions")
}

model AnalyticsEvent {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  sessionId String?  @map("session_id")
  eventType String   @map("event_type")
  eventData Json     @default("{}") @map("event_data")
  pageUrl   String?  @map("page_url")
  referrer  String?
  userAgent String?  @map("user_agent")
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([userId])
  @@map("analytics_events")
}

model PushToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String
  platform  String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@map("push_tokens")
}

model WebStory {
  id           String    @id @default(uuid())
  title        String
  slug         String    @unique
  categoryId   String?   @map("category_id")
  slides       Json      @default("[]")
  status       String    @default("draft")
  author       String?
  duration     Int       @default(0)
  coverImage   String?   @map("cover_image")
  isFeature    Boolean   @default(false) @map("is_featured")
  priority     String    @default("normal")
  viewCount    Int       @default(0) @map("view_count")
  likeCount    Int       @default(0) @map("like_count")
  shareCount   Int       @default(0) @map("share_count")
  publishedAt  DateTime? @map("published_at")
  isDeleted    Boolean   @default(false) @map("is_deleted")
  deletedAt    DateTime? @map("deleted_at")
  deletedBy    String?   @map("deleted_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  createdBy    String?   @map("created_by")
  updatedBy    String?   @map("updated_by")

  // Relations
  category         Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  createdByUser    User?     @relation("WebStoryAuthor", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser    User?     @relation("WebStoryUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)

  @@index([publishedAt(sort: Desc)])
  @@index([categoryId])
  @@index([status])
  @@index([slug])
  @@index([isDeleted])
  @@index([deletedAt])
  @@map("web_stories")
}

model AdminLog {
  id         String   @id @default(uuid())
  adminId    String?  @map("admin_id")
  action     String
  targetType String?  @map("target_type")
  targetId   String?  @map("target_id")
  details    Json     @default("{}")
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  admin User? @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@map("admin_logs")
}

// =============================================================================
// MARKET DATA MODELS - Cache external API data to avoid rate limits
// =============================================================================

model MarketIndex {
  id            String   @id @default(uuid())
  symbol        String   @unique
  name          String
  country       String
  exchange      String
  value         Float
  previousClose Float    @map("previous_close")
  change        Float
  changePercent Float    @map("change_percent")
  high          Float
  low           Float
  volume        Float?
  currency      String
  timezone      String
  isOpen        Boolean  @default(false) @map("is_open")
  lastUpdated   DateTime @map("last_updated")
  lastSource    String?  @map("last_source")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([symbol])
  @@index([country])
  @@index([lastUpdated])
  @@map("market_indices")
}

model MarketProviderPreference {
  id              String   @id @default(uuid())
  category        String   @unique
  providerOrder   String[] @map("provider_order")
  fallbackStrategy String  @default("sequential") @map("fallback_strategy")
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("market_provider_preferences")
}

model Cryptocurrency {
  id            String   @id @default(uuid())
  symbol        String   @unique
  name          String
  value         Float
  previousClose Float?   @map("previous_close")
  change        Float
  changePercent Float    @map("change_percent")
  high24h       Float?   @map("high_24h")
  low24h        Float?   @map("low_24h")
  volume24h     Float?   @map("volume_24h")
  marketCap     Float?   @map("market_cap")
  currency      String   @default("USD")
  lastUpdated   DateTime @map("last_updated")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([symbol])
  @@index([lastUpdated])
  @@map("cryptocurrencies")
}

model CurrencyRate {
  id          String   @id @default(uuid())
  pair        String   @unique // e.g., "USD/EUR"
  fromCurrency String  @map("from_currency")
  toCurrency   String  @map("to_currency")
  rate        Float
  lastUpdated DateTime @map("last_updated")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([fromCurrency])
  @@index([toCurrency])
  @@index([lastUpdated])
  @@map("currency_rates")
}

model Commodity {
  id            String   @id @default(uuid())
  symbol        String   @unique
  name          String
  value         Float
  previousClose Float?   @map("previous_close")
  change        Float?
  changePercent Float?   @map("change_percent")
  high          Float?
  low           Float?
  unit          String   @default("USD")
  category      String   @default("general") // e.g., "energy", "metals", "agriculture"
  lastUpdated   DateTime @map("last_updated")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([symbol])
  @@index([category])
  @@index([lastUpdated])
  @@map("commodities")
}

// -----------------------------------------------------------------------------
// Market configuration models managed through the admin dashboard
// -----------------------------------------------------------------------------

model MarketIndexConfig {
  id          String   @id @default(uuid())
  symbol      String   @unique
  name        String
  country     String
  region      String[] @default([])
  exchange    String
  currency    String
  timezone    String
  marketHours Json     @default("{\"open\": \"09:30\", \"close\": \"16:00\"}") @map("market_hours")
  isActive    Boolean  @default(true) @map("is_active")
  isGlobal    Boolean  @default(false) @map("is_global")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([symbol])
  @@index([country])
  @@index([isActive])
  @@index([region])
  @@map("market_index_configs")
}

model CryptocurrencyConfig {
  id          String   @id @default(uuid())
  symbol      String   @unique
  name        String
  coinGeckoId String   @unique @map("coingecko_id")
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([symbol])
  @@index([isActive])
  @@map("cryptocurrency_configs")
}

model CommodityConfig {
  id        String   @id @default(uuid())
  symbol    String   @unique
  name      String
  category  String
  unit      String   @default("USD")
  currency  String   @default("USD")
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([symbol])
  @@index([category])
  @@index([isActive])
  @@map("commodity_configs")
}

model CurrencyPairConfig {
  id        String   @id @default(uuid())
  pair      String   @unique
  name      String
  base      String
  quote     String
  type      String   @default("major")
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([pair])
  @@index([type])
  @@index([isActive])
  @@map("currency_pair_configs")
}
